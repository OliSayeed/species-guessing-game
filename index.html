<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Species Guessing Game â€” Simple Mode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --card:#fff; --ink:#111; --muted:#666; --line:#e5e7eb; --good:#0a7d25; --bad:#a60d0d; }
    html,body{margin:0;padding:0;background:#fafafa;color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    .wrap{max-width:840px;margin:28px auto;padding:0 16px;}
    h1{margin:0 0 4px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:12px}
    input[type=text]{flex:1;min-width:260px;padding:10px 12px;border:1px solid var(--line);border-radius:10px;font-size:16px}
    button{padding:10px 14px;border:1px solid var(--line);border-radius:10px;background:white;cursor:pointer}
    button:hover{background:#f3f4f6}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--line);border-radius:999px;background:#fff}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .good{color:var(--good);font-weight:700}
    .bad{color:var(--bad);font-weight:700}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .section{margin-top:18px}
    .list{display:flex;flex-direction:column;gap:8px}
    .small{font-size:14px}
    .footer{margin-top:28px;color:var(--muted);font-size:14px}
    .chip{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;margin-left:6px;font-size:12px;color:#444}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Species Guessing Game</h1>
  <p class="muted">No visuals, just signal: after each guess I show the tree <em>distance</em> to the secret target. Smaller = closer. Distance 0 = correct ðŸŽ¯</p>

  <div class="row">
    <button id="newgame">New game</button>
    <span id="turns" class="pill">turns: 0</span>
    <span id="pool" class="pill small">pool: â€¦</span>
    <span id="hint" class="pill small"></span>
  </div>

  <div class="row">
    <input id="guess" type="text" list="names" placeholder="Type a scientific or common name" autocomplete="off" />
    <datalist id="names"></datalist>
    <button id="submit">Guess</button>
  </div>

  <div id="status" class="card section" style="display:none;"></div>

  <div class="section">
    <h3>Closest so far</h3>
    <div id="closest" class="card small">None yet â€” make a guess.</div>
  </div>

  <div class="section">
    <h3>All guesses</h3>
    <div id="log" class="list"></div>
  </div>

  <div class="footer">Runs entirely locally using <code>species_pack.json</code> + <code>tree_topology.json</code>. No network during play.</div>
</div>

<script>
/* --------------------------
   Load precomputed data
--------------------------- */
let PACK=null, TOPO=null;

async function loadJSON(path){
  const r = await fetch(path, {cache:"no-store"});
  if (!r.ok) throw new Error(`Failed to load ${path}`);
  return r.json();
}

/* --------------------------
   Maps & indexes
--------------------------- */
const name2ott = new Map(); // lowercased sci or common -> ott
const ott2sci = new Map();
const ott2common = new Map();

function initMaps(){
  for (const [k,v] of Object.entries(PACK.name_to_ott)) name2ott.set(k, v);
  for (const sp of PACK.species){
    ott2sci.set(sp.ott, sp.sci);
    if (sp.common){
      ott2common.set(sp.ott, sp.common);
    }
  }
}

/* --------------------------
   LCA & distance (binary lifting)
--------------------------- */
let depth=null, up=null, childrenAll=null;

function buildLCA(){
  const n = TOPO.n, parent = TOPO.parent;
  depth = new Int32Array(n);
  const LOG = Math.ceil(Math.log2(Math.max(1,n)));
  up = Array.from({length:LOG+1}, ()=>new Int32Array(n).fill(-1));

  // children list for BFS
  childrenAll = Array.from({length:n}, ()=>[]);
  for (let v=0; v<n; v++){
    const p = parent[v];
    if (p>=0) childrenAll[p].push(v);
  }
  const root = TOPO.root;
  const q = [root];
  depth[root] = 0;
  up[0][root] = -1;

  for (let i=0; i<q.length; i++){
    const v = q[i];
    for (const w of childrenAll[v]){
      depth[w] = depth[v] + 1;
      up[0][w] = v;
      q.push(w);
    }
  }
  for (let j=1; j<up.length; j++){
    for (let v=0; v<n; v++){
      const mid = up[j-1][v];
      up[j][v] = (mid>=0 ? up[j-1][mid] : -1);
    }
  }
}

function lca(a,b){
  if (a===b) return a;
  if (depth[a] < depth[b]) [a,b] = [b,a];
  let diff = depth[a] - depth[b];
  for (let j=0; diff>0; j++, diff>>=1){ if (diff&1) a = up[j][a]; }
  if (a===b) return a;
  for (let j=up.length-1; j>=0; j--){
    if (up[j][a] !== up[j][b]){ a = up[j][a]; b = up[j][b]; }
  }
  return up[0][a];
}

function distByOtt(ottA, ottB){
  if (ottA === ottB) return 0;
  const idxA = TOPO.ott_index[String(ottA)];
  const idxB = TOPO.ott_index[String(ottB)];
  if (idxA==null || idxB==null) return Infinity;
  const c = lca(idxA, idxB);
  return (depth[idxA] + depth[idxB] - 2*depth[c]);
}

/* --------------------------
   UI helpers
--------------------------- */
function el(id){ return document.getElementById(id); }
function setTurns(n){ el("turns").textContent = `turns: ${n}`; }
function getTurns(){ return Number(el("turns").textContent.replace(/[^\d]/g,""))||0; }
function setPool(n){ el("pool").textContent = `pool: ${n}`; }
function setHint(t){ el("hint").textContent = t || ""; }
function resetUI(){ el("status").style.display="none"; el("guess").value=""; el("guess").focus(); }

function fmtSpecies(ott){
  const sci = ott2sci.get(ott) || `OTT ${ott}`;
  const cn = ott2common.get(ott);
  return cn ? `${sci} <span class="chip">${cn}</span>` : sci;
}

/* --------------------------
   Game state
--------------------------- */
let TARGET=null;   // {ott}
let GUESSES=[];    // [{ott, dist}]

function pickRandomOTT(){
  const arr = PACK.species;
  const r = arr[Math.floor(Math.random()*arr.length)];
  return r.ott;
}

function updateDatalist(){
  const dl = el("names"); dl.innerHTML = "";
  const names = [];
  for (const sp of PACK.species){ names.push(sp.sci); if (sp.common) names.push(sp.common); }
  for (const v of names.slice(0, 2500)){ const o=document.createElement("option"); o.value=v; dl.appendChild(o); }
}

/* --------------------------
   Rendering
--------------------------- */
function renderClosest(){
  if (!GUESSES.length){ el("closest").textContent = "None yet â€” make a guess."; return; }
  const best = GUESSES.reduce((a,b)=> a.dist<=b.dist ? a : b);
  el("closest").innerHTML = `
    <div><strong>${fmtSpecies(best.ott)}</strong></div>
    <div>distance to target: <span class="mono">${best.dist}</span></div>
  `;
}

function renderLog(){
  const box = el("log"); box.innerHTML = "";
  for (const g of [...GUESSES].reverse()){
    const row = document.createElement("div");
    row.className = "card small";
    row.innerHTML = `
      <div><strong>${fmtSpecies(g.ott)}</strong></div>
      <div>distance: <span class="mono">${g.dist}</span></div>
    `;
    box.appendChild(row);
  }
}

/* --------------------------
   Actions
--------------------------- */
function newGame(){
  setTurns(0);
  GUESSES.length = 0;
  TARGET = { ott: pickRandomOTT() };
  setHint(ott2sci.get(TARGET.ott));  // optional: shows the target sci name as a hint
  resetUI();
  renderClosest();
  renderLog();
}

function submitGuess(){
  const raw = el("guess").value.trim();
  if (!raw) return;

  const ott = name2ott.get(raw.toLowerCase());
  setTurns(getTurns()+1);

  if (!ott){
    const box = el("status");
    box.style.display = "block";
    box.innerHTML = `<div class="bad">Not recognized: <span class="mono">${raw}</span></div>`;
    resetUI();
    return;
  }

  // duplicates ignored
  if (GUESSES.some(g=>g.ott===ott)){ resetUI(); return; }

  const d = distByOtt(ott, TARGET.ott);
  GUESSES.push({ ott, dist: d });

  if (d === 0){
    renderClosest();
    renderLog();
    const box = el("status");
    box.style.display = "block";
    box.innerHTML = `<div class="good">You found it in ${getTurns()} turn${getTurns()===1?"":"s"} ðŸŽ‰</div>
      <div><strong>Target:</strong> ${fmtSpecies(TARGET.ott)}</div>`;
    resetUI();
    return;
  }

  renderClosest();
  renderLog();
  resetUI();
}

/* --------------------------
   Boot
--------------------------- */
(async function(){
  // Load precomputed packs (must be next to index.html)
  PACK = await loadJSON("species_pack.json");
  TOPO = await loadJSON("tree_topology.json");
  initMaps();
  buildLCA();
  setPool(PACK.species.length);
  updateDatalist();
  newGame();
})();

document.getElementById("submit").addEventListener("click", submitGuess);
document.getElementById("guess").addEventListener("keydown", e=>{ if (e.key==="Enter") submitGuess(); });
document.getElementById("newgame").addEventListener("click", newGame);
</script>
</body>
</html>
