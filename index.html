<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Species Guessing Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --card: #fff; --ink: #111; --muted: #666; --line: #e5e7eb; --good: #0a7d25; --bad:#a60d0d; }
    html,body{margin:0;padding:0;background:#fafafa;color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    .wrap{max-width:860px;margin:32px auto;padding:0 16px;}
    h1{margin:0 0 6px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type=text]{flex:1;min-width:280px;padding:10px 12px;border:1px solid var(--line);border-radius:10px;font-size:16px}
    button{padding:10px 14px;border:1px solid var(--line);border-radius:10px;background:white;cursor:pointer}
    button:hover{background:#f3f4f6}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--line);border-radius:999px;background:#fff}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .stack{display:flex;flex-direction:column;gap:10px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .good{color:var(--good);font-weight:700}
    .bad{color:var(--bad);font-weight:700}
    .grid{display:grid;grid-template-columns:1fr auto;gap:8px}
    .small{font-size:14px}
    .list{display:flex;flex-direction:column-reverse;gap:10px} /* newest first */
    .section{margin-top:18px}
    .sr{position:absolute;left:-9999px}
    .footer{margin-top:28px;color:var(--muted);font-size:14px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Species Guessing Game</h1>
  <p class="muted">Guess any species (common or scientific). Iâ€™ll reveal the <em>MRCA</em> with the secret target so you can triangulate it.</p>

  <div class="row section">
    <button id="newgame">New game</button>
    <span id="turns" class="pill">turns: 0</span>
    <span id="targetHint" class="pill small"></span>
  </div>

  <div class="row section">
    <label class="sr" for="guess">Your guess</label>
    <input id="guess" type="text" list="seednames" placeholder="e.g., hoatzin or Opisthocomus hoazin" />
    <datalist id="seednames"></datalist>
    <button id="submit">Guess</button>
  </div>

  <div id="status" class="card section" style="display:none;"></div>

  <div class="section">
    <h3>History</h3>
    <div id="log" class="list"></div>
  </div>

  <div class="footer">Powered by OpenTree (TNRS + MRCA). Entirely client-side â€” no installs needed.</div>
</div>

<script>
  // -------------------------------
  // Config (OpenTree API endpoints)
  // -------------------------------
  const OT_BASE = "https://api.opentreeoflife.org/v3";
  const TNRS_URL = `${OT_BASE}/tnrs/match_names`;
  const MRCA_URL = `${OT_BASE}/tree_of_life/mrca`;
  const NODE_INFO_URL = `${OT_BASE}/tree_of_life/node_info`;

  // -------------------------------
  // Seed playable species (OTT IDs)
  // You can expand/replace this later with a generated JSON.
  // -------------------------------
  const SEED = [
    // Afrotheria reps + friends (mammals)
    {ott:770315, sci:"Orycteropus afer", common:"Aardvark"},
    {ott:770309, sci:"Loxodonta africana", common:"African elephant"},
    {ott:770311, sci:"Elephas maximus", common:"Asian elephant"},
    {ott:770322, sci:"Dugong dugon", common:"Dugong"},
    {ott:770321, sci:"Trichechus manatus", common:"American manatee"},
    {ott:770318, sci:"Procavia capensis", common:"Rock hyrax"},
    {ott:987545, sci:"Tenrec ecaudatus", common:"Common tenrec"},
    {ott:770320, sci:"Rhynchocyon petersi", common:"Black-and-rufous elephant shrew"},

    // Birds
    {ott:292466, sci:"Opisthocomus hoazin", common:"Hoatzin"},
    {ott:81461,  sci:"Struthio camelus",   common:"Ostrich"},
    {ott:144183, sci:"Corvus corax",        common:"Common raven"},
    {ott:803750, sci:"Sturnus vulgaris",    common:"Common starling"},

    // Plants (Poaceae +)
    {ott:412129, sci:"Zea mays",            common:"Maize"},
    {ott:241806, sci:"Triticum aestivum",   common:"Bread wheat"},
    {ott:423369, sci:"Oryza sativa",        common:"Rice"},
    {ott:536338, sci:"Bambusa vulgaris",    common:"Common bamboo"},
    {ott:555741, sci:"Hordeum vulgare",     common:"Barley"},
    {ott:292270, sci:"Avena sativa",        common:"Oat"},

    // Invertebrates
    {ott:301648, sci:"Coccinella septempunctata", common:"Seven-spot ladybird"},
    {ott:344103, sci:"Lampyris noctiluca",        common:"Common glow-worm"},
    {ott:1016910,sci:"Lucanus cervus",            common:"European stag beetle"},
  ];

  // Build quick lookup maps for offline matching
  const NAME2OTT = new Map();
  const OTT2NAME = new Map();
  for (const s of SEED) {
    NAME2OTT.set(s.sci.toLowerCase(), s.ott);
    NAME2OTT.set(s.common.toLowerCase(), s.ott);
    OTT2NAME.set(s.ott, s);
  }

  // Fill datalist for light autocomplete
  const dl = document.getElementById("seednames");
  for (const s of SEED) {
    for (const v of [s.common, s.sci]) {
      const o = document.createElement("option"); o.value = v; dl.appendChild(o);
    }
  }

  // -------------------------------
  // Game state (client-side only)
  // -------------------------------
  let target = null;      // {ott, sci, common}
  let turns = 0;
  const history = [];     // array of entries rendered to the log

  // -------------------------------
  // Helpers: OpenTree calls
  // -------------------------------
  async function tnrsResolve(name) {
    // Returns {ott, sci} or null
    try {
      const r = await fetch(TNRS_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ names: [name], do_approximate_matching: true })
      });
      if (!r.ok) return null;
      const j = await r.json();
      const res = j?.results?.[0]?.matches?.[0]?.taxon;
      if (!res?.ott_id || !res?.name) return null;
      return { ott: res.ott_id, sci: res.name };
    } catch { return null; }
  }

  async function mrcaOf(ottA, ottB) {
    // Returns {name, ott, tips} (best effort)
    try {
      const r = await fetch(MRCA_URL, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ ott_ids: [ottA, ottB] })
      });
      if (!r.ok) return { name:null, ott:null, tips:null };
      const node_id = (await r.json()).node_id;
      if (!node_id) return { name:null, ott:null, tips:null };
      const r2 = await fetch(NODE_INFO_URL, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ node_id, include_lineage:false })
      });
      if (!r2.ok) return { name:null, ott:null, tips:null };
      const j2 = await r2.json();
      return { name: j2.name ?? null, ott: j2.ott_id ?? null, tips: (j2.num_tips ?? j2.num_synth_tips ?? null) };
    } catch { return { name:null, ott:null, tips:null }; }
  }

  // -------------------------------
  // UI helpers
  // -------------------------------
  function el(id){ return document.getElementById(id); }
  function setTurns(n){ turns = n; el("turns").textContent = `turns: ${turns}`; }
  function clearLog(){ el("log").innerHTML = ""; history.length = 0; }
  function addLog(entry){
    history.push(entry);
    const box = document.createElement("div");
    box.className = "card small";
    if (!entry.resolved) {
      box.innerHTML = `
        <div><strong>Guess:</strong> ${entry.raw}</div>
        <div class="bad">Not recognized.</div>
      `;
    } else if (entry.correct) {
      box.innerHTML = `
        <div><strong>Guess:</strong> ${entry.raw}</div>
        <div>Resolved: <span class="mono">${entry.guess_name}</span> (OTT ${entry.guess_ott})</div>
        <div class="good">Correct! ðŸŽ‰</div>
      `;
    } else {
      const mrcaBits = entry.mrca_name ? `${entry.mrca_name} ${entry.mrca_ott ? `(OTT ${entry.mrca_ott})` : ""}` : "unknown";
      const tips = entry.mrca_tips != null ? ` â€¢ clade size: ${entry.mrca_tips}` : "";
      box.innerHTML = `
        <div><strong>Guess:</strong> ${entry.raw}</div>
        <div>Resolved: <span class="mono">${entry.guess_name}</span> (OTT ${entry.guess_ott})</div>
        <div>MRCA: <span class="mono">${mrcaBits}</span>${tips}</div>
      `;
    }
    el("log").appendChild(box); // list is column-reverse via CSS
  }

  function showStatusFound(sp){
    const t = el("status");
    t.style.display = "block";
    t.innerHTML = `
      <div class="good">You found it in ${turns} turn${turns===1?"":"s"}.</div>
      <div><strong>Target:</strong> ${sp.common || sp.sci} <span class="mono">(${sp.sci})</span> â€” OTT ${sp.ott}</div>
    `;
  }

  // -------------------------------
  // Game actions
  // -------------------------------
  function newGame(){
    // Pick a random target from the current seed pool
    target = SEED[Math.floor(Math.random()*SEED.length)];
    setTurns(0);
    clearLog();
    el("status").style.display = "none";
    el("targetHint").textContent = ""; // placeholder for future (e.g., kingdom)
    el("guess").value = "";
    el("guess").focus();
  }

  async function submitGuess(){
    if (!target) return;
    const raw = el("guess").value.trim();
    if (!raw) return;

    // 1) resolve guess to an OTT id (try local, then TNRS)
    let guessOtt = NAME2OTT.get(raw.toLowerCase());
    let guessName = null; // display canonical sci name

    if (guessOtt) {
      // use local sci name if available
      guessName = OTT2NAME.get(guessOtt)?.sci || raw;
    } else {
      const tnrs = await tnrsResolve(raw);
      if (!tnrs) {
        setTurns(turns+1);
        addLog({ raw, resolved:false });
        el("guess").value = "";
        el("guess").focus();
        return;
      }
      guessOtt = tnrs.ott;
      guessName = tnrs.sci;
    }

    const correct = (guessOtt === target.ott);
    setTurns(turns+1);

    if (correct) {
      addLog({ raw, resolved:true, correct:true, guess_ott: guessOtt, guess_name: guessName });
      showStatusFound(target);
      el("guess").value = "";
      el("guess").focus();
      return;
    }

    // 2) not correct â†’ MRCA
    const m = await mrcaOf(target.ott, guessOtt);
    addLog({
      raw, resolved:true, correct:false,
      guess_ott: guessOtt, guess_name: guessName,
      mrca_name: m.name, mrca_ott: m.ott, mrca_tips: m.tips
    });

    el("guess").value = "";
    el("guess").focus();
  }

  // Wire up UI
  document.getElementById("newgame").addEventListener("click", newGame);
  document.getElementById("submit").addEventListener("click", submitGuess);
  document.getElementById("guess").addEventListener("keydown", (e)=>{ if (e.key==="Enter") submitGuess(); });

  // auto-start one
  newGame();
</script>
</body>
</html>
